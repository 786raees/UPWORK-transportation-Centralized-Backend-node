# Story 1.2: VAPI Batch Driver Calls

## Status
Updated - Ready for Implementation

## Story
**As a** system administrator,  
**I want** to make VAPI AI-powered calls to multiple drivers simultaneously using a list of driver IDs,  
**so that** I can efficiently conduct batch safety communications or emergency notifications to multiple drivers at once.

## Acceptance Criteria
1. Create new API endpoint `POST /api/vapi-calls/batch` that accepts an array of driver IDs
2. Process multiple drivers simultaneously using enhanced VAPI client from Story 1.1
3. Make a single VAPI campaign call with multiple drivers' complete information
4. Return a comprehensive JSON response with the campaign details and all driver information
5. Handle driver lookup failures gracefully (exclude invalid drivers, proceed with valid ones)
6. Follow existing error handling patterns from Story 1.1 implementation
7. Leverage VAPI's native multi-customer campaign feature for optimal performance

## Tasks / Subtasks
- [ ] Add batch VAPI call controller method (AC: 1, 2, 3, 4, 5)
  - [ ] Add `makeVapiCallsToMultipleDrivers` method to `controllers/callController.js`
  - [ ] Implement driver ID validation and bulk lookup using existing Sequelize patterns
  - [ ] Use enhanced VAPI client from Story 1.1 with array input for single campaign
  - [ ] Handle invalid drivers by filtering them out and proceeding with valid drivers
  - [ ] Return comprehensive campaign results with all driver information
- [ ] Create new batch API route (AC: 1)
  - [ ] Add route `POST /api/vapi-calls/batch` to `routes/calls.js`
  - [ ] Connect route to new batch controller method
- [ ] Implement batch error handling (AC: 5, 6)
  - [ ] Handle individual driver lookup failures without stopping batch
  - [ ] Filter out invalid drivers and log warnings
  - [ ] Use existing error handling patterns from Story 1.1
- [ ] Testing (AC: 1-7)
  - [ ] Test with multiple valid driver IDs
  - [ ] Test with mixed valid/invalid driver IDs
  - [ ] Test with all invalid driver IDs
  - [ ] Test single campaign creation with multiple customers

## Dev Notes

### Dependencies
**CRITICAL: Requires Story 1.1 to be completed and tested** - This story builds on the enhanced VAPI campaign client utility from Story 1.1 that now supports multiple drivers in a single campaign.

**Prerequisites:**
- Story 1.1 enhanced VAPI client (`utils/vapiClient.js`) with multi-driver support must be implemented and tested
- All VAPI environment variables (API_KEY, ASSISTANT_ID, PHONENUMBER_ID) must be configured
- Database connection must be working (required for bulk driver lookups)
- Test driver `DRV_1753320481164` should be available for testing

### Technology Stack Context
[Source: docs/architecture.md#technology-stack + Story 1.1 enhancement]
- **Framework**: Express.js 5.1.0 - maintain existing patterns
- **Database**: MySQL via Sequelize 6.37.7 - use existing Driver model for bulk lookups
- **HTTP Client**: Axios 1.10.0 - use enhanced VAPI client from Story 1.1
- **VAPI Integration**: Single campaign with multiple customers (no rate limiting needed)

### Enhanced Batch Processing Pattern
[Source: Story 1.1 enhanced createVapiCall function]
Simplified approach using the enhanced VAPI client that supports multiple drivers:
```javascript
// Enhanced batch pattern using single VAPI campaign
async function makeVapiCallsToMultipleDrivers(req, res) {
  try {
    const { driverIds } = req.body;
    
    // Validate input
    if (!Array.isArray(driverIds) || driverIds.length === 0) {
      return res.status(400).json({
        error: 'driverIds must be a non-empty array',
        status: 'validation_error'
      });
    }

    // Bulk lookup drivers
    const drivers = await Driver.findAll({
      where: {
        driverId: {
          [Op.in]: driverIds
        }
      }
    });

    // Filter out invalid driver IDs and log warnings
    const validDrivers = drivers.filter(driver => driver);
    const foundDriverIds = validDrivers.map(d => d.driverId);
    const invalidDriverIds = driverIds.filter(id => !foundDriverIds.includes(id));
    
    if (invalidDriverIds.length > 0) {
      console.warn(`⚠️ Invalid driver IDs: ${invalidDriverIds.join(', ')}`);
    }

    if (validDrivers.length === 0) {
      return res.status(400).json({
        error: 'No valid drivers found',
        status: 'no_valid_drivers',
        invalidDriverIds
      });
    }

    // Use enhanced VAPI client with multiple drivers (single campaign)
    const vapiResponse = await createVapiCall(validDrivers);

    // Return comprehensive response
    res.json({
      success: true,
      campaignId: vapiResponse.campaignId,
      totalDrivers: driverIds.length,
      validDrivers: validDrivers.length,
      invalidDrivers: invalidDriverIds.length,
      invalidDriverIds,
      status: vapiResponse.status,
      customers: vapiResponse.customers
    });

  } catch (error) {
    console.error('❌ Error in batch VAPI calls:', error.message);
    res.status(500).json({
      error: error.message,
      status: 'batch_vapi_error'
    });
  }
}
```

### VAPI Client Integration
[Source: Story 1.1 enhanced implementation]
Use the enhanced VAPI campaign client utility from Story 1.1 that now supports multiple drivers:
```javascript
// Import enhanced client from Story 1.1
const { createVapiCall } = require('../utils/vapiClient');

// Use with array of drivers (creates single campaign with multiple customers)
const vapiResponse = await createVapiCall(validDrivers);

// Enhanced response includes all customer details
// {
//   success: true,
//   campaignId: "...",
//   callId: "...",
//   status: "scheduled",
//   customerCount: 3,
//   customers: [
//     { name: "John Doe", number: "+1234567890", driverId: "DRV_123" },
//     { name: "Jane Smith", number: "+1234567891", driverId: "DRV_124" }
//   ]
// }
```

**ENHANCED**: Story 1.1 VAPI client now accepts both single driver objects and arrays, creating a single VAPI campaign with multiple customers for improved efficiency.

### Driver Model Context
[Source: docs/architecture.md#data-models and Story 1.1]
Use existing Driver model for bulk lookups:
```javascript
// Bulk driver lookup pattern
const drivers = await Driver.findAll({
  where: {
    driverId: {
      [Op.in]: driverIds
    }
  }
});
```

### Request/Response Format
**Request Format:**
```javascript
{
  "driverIds": ["DRV_1753320481164", "DRV_1753320481165", "DRV_1753320481166"]
}
```

**Response Format (enhanced single campaign approach):**
```javascript
{
  "success": true,
  "campaignId": "50a3619d-5598-4032-ac1c-41d220049086",
  "totalDrivers": 3,
  "validDrivers": 2,
  "invalidDrivers": 1,
  "invalidDriverIds": ["DRV_1753320481166"],
  "status": "scheduled",
  "customers": [
    {
      "name": "Alina Khan",
      "number": "+1 (219) 200-2824",
      "driverId": "DRV_1753320481164"
    },
    {
      "name": "Andy Smith", 
      "number": "+1 (317) 559-2104",
      "driverId": "DRV_1753320481165"
    }
  ]
}
```

**Error Response (no valid drivers):**
```javascript
{
  "error": "No valid drivers found",
  "status": "no_valid_drivers",
  "invalidDriverIds": ["DRV_1753320481166", "INVALID_DRIVER"]
}
```

### File Locations
[Source: docs/architecture.md#project-structure and Story 1.1]
- **Controller**: `controllers/callController.js` - add new batch method
- **Routes**: `routes/calls.js` - add new batch endpoint
- **Utilities**: Use existing `utils/vapiClient.js` from Story 1.1
- **Environment**: Use existing VAPI credentials from Story 1.1

### Error Handling Strategy
Handle two main types of scenarios:
1. **Invalid Driver IDs**: Individual driver lookup fails - filter out and proceed with valid drivers
2. **VAPI Campaign Error**: Single campaign creation fails for all drivers
3. **System Error**: Database connection or other system issues

Invalid drivers are filtered out and reported in the response without stopping the campaign creation for valid drivers.

### Environment Variables Required
[Source: Story 1.1 working implementation]
```env
VAPI_API_KEY=your_vapi_api_key_here
VAPI_ASSISTANT_ID=your_assistant_id_here
VAPI_PHONENUMBER_ID=your_phone_number_id_here
```

**CRITICAL**: All three environment variables are required for VAPI campaign API to work.

## Testing
### Testing Standards
[Source: existing project analysis and Story 1.1]
- **Manual Testing**: Use Postman or cURL for endpoint testing
- **Test Location**: No formal test framework - manual API testing
- **Error Testing**: Test both success and failure scenarios
- **Batch Testing**: Verify single campaign creation with multiple customers

### Test Cases Required
1. **All Valid Drivers Test**: POST /api/vapi-calls/batch with `["DRV_1753320481164", "DRV_1753320481165"]`
   - Expected: 200 status, single campaign with multiple customers, `status: "scheduled"`
2. **Mixed Valid/Invalid Test**: POST /api/vapi-calls/batch with `["DRV_1753320481164", "INVALID_ID"]`
   - Expected: 200 status, single campaign with valid drivers, invalid IDs listed separately
3. **All Invalid Drivers Test**: POST /api/vapi-calls/batch with `["INVALID_1", "INVALID_2"]`
   - Expected: 400 status with `status: "no_valid_drivers"`
4. **Single Campaign Verification**: Verify VAPI creates one campaign with multiple customers
5. **Environment Variable Test**: Test with missing VAPI credentials
   - Expected: 500 status with `batch_vapi_error`
6. **Empty Array Test**: POST with `{"driverIds": []}`
   - Expected: 400 status with `validation_error`

### Sample Test Commands
```bash
# Test with multiple valid drivers
curl -X POST http://localhost:8000/api/vapi-calls/batch \
  -H "Content-Type: application/json" \
  -d '{
    "driverIds": ["DRV_1753320481164", "DRV_1753320481165"]
  }'

# Test with mixed valid/invalid drivers
curl -X POST http://localhost:8000/api/vapi-calls/batch \
  -H "Content-Type: application/json" \
  -d '{
    "driverIds": ["DRV_1753320481164", "INVALID_DRIVER"]
  }'

# Test with empty array
curl -X POST http://localhost:8000/api/vapi-calls/batch \
  -H "Content-Type: application/json" \
  -d '{
    "driverIds": []
  }'
```

**Expected Responses:**
- Valid drivers: Status 200 with single `campaignId` and `status: "scheduled"`
- Mixed valid/invalid: Status 200 with campaign for valid drivers and `invalidDriverIds` array
- All invalid: Status 400 with `no_valid_drivers` error
- Empty array: Status 400 with `validation_error`

### Developer Notes & Troubleshooting

#### Critical Implementation Details (from Story 1.1 enhancement)
1. **Single Campaign Approach**: Enhanced VAPI client creates one campaign with multiple customers
2. **No Rate Limiting Needed**: Single API call handles all drivers simultaneously
3. **Environment Variables**: All three VAPI variables (API_KEY, ASSISTANT_ID, PHONENUMBER_ID) are mandatory
4. **Driver Filtering**: Invalid drivers are filtered out, valid drivers proceed in single campaign
5. **Sequelize Bulk Lookup**: Use `Driver.findAll({ where: { driverId: { [Op.in]: driverIds } } })`

#### Enhanced Processing Pattern
```javascript
// Simplified pattern using enhanced VAPI client
try {
  // Bulk lookup and filter valid drivers
  const validDrivers = await getValidDrivers(driverIds);
  
  // Single VAPI campaign call with multiple customers
  const vapiResponse = await createVapiCall(validDrivers);
  
  // Return single campaign response
  return {
    success: true,
    campaignId: vapiResponse.campaignId,
    status: vapiResponse.status,
    customers: vapiResponse.customers
  };
} catch (error) {
  // Handle campaign-level error
  return { error: error.message, status: 'batch_vapi_error' };
}
```

#### Common Issues & Solutions
- **Missing Story 1.1 enhancement**: VAPI client doesn't support arrays → Verify Story 1.1 createVapiCall accepts arrays
- **Database timeout on bulk lookup**: Too many driver IDs → Implement chunking for very large batches (>100 drivers)
- **All drivers invalid**: Empty valid drivers array → Return 400 status with helpful error message
- **VAPI campaign creation failure**: Single point of failure → Ensure proper error handling and logging

#### Response Status Meanings
- `scheduled`: VAPI campaign created successfully with multiple customers
- `no_valid_drivers`: All provided driver IDs were invalid
- `validation_error`: Invalid request format or empty driver array
- `batch_vapi_error`: VAPI campaign creation failed

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | Initial story creation for VAPI batch driver calls | Bob (Scrum Master) |
| 2024-12-19 | 2.0 | Updated with Story 1.1 learnings and working VAPI campaign structure | James (Dev Agent) |
| 2024-12-19 | 3.0 | Simplified approach using enhanced createVapiCall function that supports multiple drivers in single campaign | Claude (Dev Agent) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent QA review will be added here after implementation* 