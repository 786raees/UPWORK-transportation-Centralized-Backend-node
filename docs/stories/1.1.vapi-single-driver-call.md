# Story 1.1: VAPI Single Driver Call

## Status
Draft

## Story
**As a** system administrator,  
**I want** to make VAPI AI-powered calls to individual drivers using their driver ID,  
**so that** drivers can receive AI-powered safety communications with all their relevant information passed to the VAPI assistant.

## Acceptance Criteria
1. Create new API endpoint `POST /api/vapi-call/:driverId` that accepts a driver ID parameter
2. Retrieve driver information from the existing Driver model using the provided driver ID
3. Make a VAPI API call with driver's complete information (firstName, lastName, phoneNumber, etc.)
4. Return a JSON response with call status, call ID, and driver information
5. Handle errors appropriately (driver not found, VAPI API errors, network issues)
6. Follow existing error handling and response patterns from the current RingCentral implementation

## Tasks / Subtasks
- [ ] Create VAPI utility client (AC: 3)
  - [ ] Create `utils/vapiClient.js` with VAPI API communication functions
  - [ ] Add VAPI environment variables to .env (VAPI_API_KEY, VAPI_ASSISTANT_ID)
  - [ ] Implement createVapiCall function with driver data mapping
- [ ] Add VAPI call controller method (AC: 1, 2, 3, 4)
  - [ ] Add `makeVapiCall` method to `controllers/callController.js`
  - [ ] Implement driver lookup using existing Sequelize pattern
  - [ ] Map driver data to VAPI customer format
  - [ ] Handle VAPI API response and return appropriate JSON
- [ ] Create new API route (AC: 1)
  - [ ] Add route `POST /api/vapi-call/:driverId` to `routes/calls.js`
  - [ ] Connect route to controller method
- [ ] Implement error handling (AC: 5, 6)
  - [ ] Handle driver not found (404 error)
  - [ ] Handle VAPI API errors (502 error with VAPI details)
  - [ ] Follow existing error response format
- [ ] Testing (AC: 1-6)
  - [ ] Test with valid driver ID
  - [ ] Test with invalid driver ID
  - [ ] Test VAPI API integration with real driver data

## Dev Notes

### Technology Stack Context
[Source: docs/architecture.md#technology-stack]
- **Framework**: Express.js 5.1.0 - maintain existing patterns
- **Database**: MySQL via Sequelize 6.37.7 - use existing Driver model
- **HTTP Client**: Axios 1.10.0 - use for VAPI API calls
- **No new dependencies required** - use existing axios for VAPI integration

### Driver Model Context
[Source: docs/architecture.md#data-models]
The existing Driver model contains all necessary information for VAPI calls:
```javascript
{
  driverId: String (Primary Key),
  firstName: String,
  lastName: String, 
  phoneNumber: String,
  email: String,
  truckId: String,
  companyId: String,
  dispatcher: String,
  // ... other fields available for context
}
```

### Existing Controller Patterns
[Source: existing callController.js analysis]
Follow the existing async/await pattern:
- Use `try/catch` blocks with `console.error` for error logging
- Return JSON responses with consistent structure
- Use existing Sequelize patterns for database queries
- Follow existing error status code patterns (404, 500, etc.)

### API Integration Requirements
[Source: VAPI documentation and architecture planning]
- **VAPI API Base URL**: https://api.vapi.ai
- **Authentication**: Bearer token using VAPI_API_KEY
- **Assistant ID**: f630d5ab-148a-40f0-8059-027141d7f45f
- **Customer Data Format**: 
  ```javascript
  {
    number: driver.phoneNumber,
    name: `${driver.firstName} ${driver.lastName}`,
    metadata: {
      driverId: driver.driverId,
      truckId: driver.truckId,
      companyId: driver.companyId
    }
  }
  ```

### File Locations
[Source: docs/architecture.md#project-structure]
- **Controller**: `controllers/callController.js` - add new method
- **Routes**: `routes/calls.js` - add new endpoint
- **Utilities**: `utils/vapiClient.js` - new file for VAPI integration
- **Environment**: `.env` - add VAPI credentials

### Response Format Requirements
Follow existing API response patterns:
```javascript
// Success response
{
  success: true,
  callId: "vapi_call_id",
  driverId: "driver_123",
  phoneNumber: "+1234567890",
  status: "initiated"
}

// Error response
{
  error: "Error message",
  status: "error_type"
}
```

### Environment Variables Required
Add to existing .env file:
```env
VAPI_API_KEY=42cd6dd5-a268-42da-a2ba-f4f343ec023c
VAPI_ASSISTANT_ID=f630d5ab-148a-40f0-8059-027141d7f45f
```

## Testing
### Testing Standards
[Source: existing project analysis]
- **Manual Testing**: Use Postman or cURL for endpoint testing
- **Test Location**: No formal test framework - manual API testing
- **Error Testing**: Test both success and failure scenarios
- **Database Testing**: Verify driver lookup functionality

### Test Cases Required
1. **Valid Driver Test**: POST /api/vapi-call/valid_driver_id
2. **Invalid Driver Test**: POST /api/vapi-call/nonexistent_id (expect 404)
3. **VAPI Integration Test**: Verify actual VAPI call creation
4. **Error Handling Test**: Test network failures and API errors

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | Initial story creation for VAPI single driver call | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent QA review will be added here after implementation* 